<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Editar Compra</title>
  <link rel="stylesheet" href="./css/tailwind.css">
</head>
<body class="bg-gray-100 p-6">
  <div id="formEditar" class="max-w-lg mx-auto bg-white p-6 rounded shadow">
    <p>Cargando formulario de edición…</p>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const compraCtrl     = require('../controllers/compraController');
      const obraCtrl       = require('../controllers/obraController');
      const insumoCtrl     = require('../controllers/insumoController');
      const proveedorCtrl  = require('../controllers/proveedorController');
      const cont           = document.getElementById('formEditar');
      const params         = new URLSearchParams(window.location.search);
      const id             = parseInt(params.get('id'), 10);

      // 1) Cargar obras, insumos y proveedores en paralelo
      Promise.all([
        new Promise((res, rej) => obraCtrl.listar((e, r) => e ? rej(e) : res(r))),
        new Promise((res, rej) => insumoCtrl.listar((e, r) => e ? rej(e) : res(r))),
        proveedorCtrl.listar() // asume Promise
      ])
      .then(([obras, insumos, proveedores]) => {
        // 2) Cargar la compra a editar
        compraCtrl.listar((errC, compras) => {
          if (errC) {
            cont.innerHTML = '<p class="text-red-500">Error al cargar compra</p>';
            return;
          }
          const c = (compras || []).find(x => x.id === id);
          if (!c) {
            cont.innerHTML = '<p class="text-red-500">Compra no encontrada.</p>';
            return;
          }

          // 3) Renderizar formulario con selects para obra, insumo y proveedor
          cont.innerHTML = `
            <h1 class="text-2xl font-bold mb-4">Editar Compra #${c.id}</h1>
            
            <label class="block mb-2">Obra:
              <select id="edit_obra" class="w-full p-2 border rounded mb-4">
                ${obras.map(o => `<option value="${o.id}">${o.nombre}</option>`).join('')}
              </select>
            </label>

            <label class="block mb-2">Insumo:
              <select id="edit_insumo" class="w-full p-2 border rounded mb-4">
                ${insumos.map(i => `<option value="${i.id}">${i.nombre}</option>`).join('')}
              </select>
            </label>

            <label class="block mb-2">Proveedor:
              <select id="edit_proveedor" class="w-full p-2 border rounded mb-4">
                ${proveedores.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
              </select>
            </label>

            <label class="block mb-2">Nombre:
              <input id="edit_nombre" type="text" value="${c.nombre}"
                     class="w-full p-2 border rounded mb-4"/>
            </label>

            <label class="block mb-2">Fecha:
              <input id="edit_fecha" type="date" value="${c.fecha}"
                     class="w-full p-2 border rounded mb-4"/>
            </label>

            <label class="block mb-2">Pedido:
              <input id="edit_pedido" type="text" value="${c.pedido}"
                     class="w-full p-2 border rounded mb-4"/>
            </label>

            <div class="grid grid-cols-3 gap-4 mb-4">
              <div>
                <label class="block mb-1">Cantidad:</label>
                <input id="edit_cantidad" type="number" step="0.01" value="${c.cantidad}"
                       class="w-full p-2 border rounded"/>
              </div>
              <div>
                <label class="block mb-1">Precio:</label>
                <input id="edit_precio" type="number" step="0.01" value="${c.precio}"
                       class="w-full p-2 border rounded"/>
              </div>
              <div>
                <label class="block mb-1">Importe:</label>
                <input id="edit_importe" type="number" step="0.01" value="${c.importe}"
                       class="w-full p-2 border rounded"/>
              </div>
            </div>

            <div class="flex justify-end space-x-2">
              <button id="cancelBtn" class="bg-gray-400 text-white px-4 py-2 rounded">
                Cancelar
              </button>
              <button id="updateBtn" class="bg-blue-600 text-white px-4 py-2 rounded">
                Actualizar
              </button>
            </div>
          `;

          // 4) Preseleccionar valores actuales
          document.getElementById('edit_obra').value      = c.obra_id;
          document.getElementById('edit_insumo').value    = c.insumo_id;
          document.getElementById('edit_proveedor').value = c.proveedor_id;

          // 5) Botones de acción
          document.getElementById('cancelBtn').onclick = () => window.history.back();
          document.getElementById('updateBtn').onclick = () => {
            const updatedData = {
              obra_id:     parseInt(document.getElementById('edit_obra').value, 10),
              insumo_id:   parseInt(document.getElementById('edit_insumo').value, 10),
              proveedor_id: parseInt(document.getElementById('edit_proveedor').value, 10),
              nombre:      document.getElementById('edit_nombre').value.trim(),
              fecha:       document.getElementById('edit_fecha').value,
              pedido:      document.getElementById('edit_pedido').value.trim(),
              cantidad:    parseFloat(document.getElementById('edit_cantidad').value) || 0,
              precio:      parseFloat(document.getElementById('edit_precio').value)   || 0,
              importe:     parseFloat(document.getElementById('edit_importe').value)  || 0
            };
            compraCtrl.editar(c.id, updatedData, err => {
              if (err) {
                alert('Error al actualizar compra');
              } else {
                alert('Compra actualizada exitosamente');
                window.history.back();
              }
            });
          };
        });
      })
      .catch(err => {
        console.error(err);
        cont.innerHTML = '<p class="text-red-500">Error al cargar datos de soporte</p>';
      });
    });
  </script>
</body>
</html>
