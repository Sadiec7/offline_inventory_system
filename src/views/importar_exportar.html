<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exportar/Importar Datos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="js/importar_exportarView.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <div class="max-w-7xl mx-auto p-6 flex-1 flex flex-col">
    <div class="bg-white shadow-xl rounded-lg flex-1 flex flex-col overflow-hidden">

      <!-- Encabezado con pesta√±as -->
      <div class="bg-blue-600 text-white p-6">
        <h1 class="text-3xl font-bold mb-2">üìä Gesti√≥n de Datos</h1>
        <p class="text-blue-100">Sistema de exportaci√≥n e importaci√≥n para SQLite y Excel</p>
      </div>

      <!-- Pesta√±as -->
      <div class="flex bg-gray-100 border-b border-gray-200">
        <button id="tab-export" class="flex-1 py-4 px-6 text-center font-semibold text-blue-600 border-b-2 border-blue-600 bg-white transition-colors hover:bg-gray-50">
          üì§ Exportar
        </button>
        <button id="tab-import" class="flex-1 py-4 px-6 text-center font-semibold text-gray-600 border-b-2 border-transparent transition-colors hover:bg-gray-50">
          üì• Importar
        </button>
      </div>

      <!-- Contenido principal -->
      <div class="flex-1 flex flex-col md:flex-row">
        
        <!-- SECCI√ìN EXPORTAR -->
        <div id="export-section" class="flex-1 flex flex-col md:flex-row">
          
          <!-- Lista lateral - Opciones de exportaci√≥n -->
          <aside class="w-full md:w-1/3 bg-gray-50 p-6 border-b md:border-b-0 md:border-r border-gray-200">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Opciones de Exportaci√≥n</h3>
            
            <!-- Exportar SQLite -->
            <div class="mb-6 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
              <h4 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <span class="text-blue-600">üíæ</span>
                Base de Datos Completa
              </h4>
              <p class="text-sm text-gray-600 mb-3">Exporta una copia completa de la base de datos SQLite</p>
              <button id="export-sqlite" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                Exportar SQLite
              </button>
            </div>

            <!-- Tablas disponibles -->
            <div class="mb-6 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
              <h4 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                <span class="text-green-600">üìä</span>
                Tablas para Excel
              </h4>
              <div class="space-y-2">
                <label class="flex items-center gap-2 text-sm">
                  <input type="checkbox" id="table-usuarios" value="usuarios" checked class="text-blue-600 rounded">
                  <span class="text-gray-700">üë• Usuarios</span>
                </label>
                <label class="flex items-center gap-2 text-sm">
                  <input type="checkbox" id="table-obras" value="obras" checked class="text-blue-600 rounded">
                  <span class="text-gray-700">üèóÔ∏è Obras</span>
                </label>
                <label class="flex items-center gap-2 text-sm">
                  <input type="checkbox" id="table-insumos" value="insumos" checked class="text-blue-600 rounded">
                  <span class="text-gray-700">üì¶ Insumos</span>
                </label>
                <label class="flex items-center gap-2 text-sm">
                  <input type="checkbox" id="table-proveedores" value="proveedores" checked class="text-blue-600 rounded">
                  <span class="text-gray-700">üè¢ Proveedores</span>
                </label>
                <label class="flex items-center gap-2 text-sm">
                  <input type="checkbox" id="table-compras" value="compras" checked class="text-blue-600 rounded">
                  <span class="text-gray-700">üõí Compras</span>
                </label>
              </div>
              <button id="export-excel" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                Exportar a Excel
              </button>
            </div>

            <!-- Informaci√≥n -->
            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
              <h4 class="font-semibold text-blue-800 mb-2">‚ÑπÔ∏è Informaci√≥n</h4>
              <ul class="text-sm text-blue-700 space-y-1">
                <li>‚Ä¢ SQLite: Copia exacta de la DB</li>
                <li>‚Ä¢ Excel: Hojas separadas por tabla</li>
                <li>‚Ä¢ Formato con encabezados</li>
                <li>‚Ä¢ Fechas formateadas</li>
              </ul>
            </div>
          </aside>

          <!-- Panel principal - Estado y resultados -->
          <section class="w-full md:flex-1 p-6 overflow-auto relative">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-gray-800 mb-2">Exportar Datos</h2>
              <p class="text-gray-600">Selecciona el formato y las tablas que deseas exportar</p>
            </div>

            <!-- Estado de exportaci√≥n -->
            <div id="export-status" class="hidden p-4 rounded-lg mb-6">
              <p id="export-message" class="font-semibold"></p>
            </div>

            <!-- Barra de progreso -->
            <div id="export-progress" class="hidden mb-6">
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="export-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <p class="text-sm text-gray-600 mt-2">Procesando exportaci√≥n...</p>
            </div>

            <!-- Resultados recientes -->
            <div class="bg-gray-50 rounded-lg p-4">
              <h3 class="font-semibold text-gray-700 mb-3">üìã Exportaciones Recientes</h3>
              <div id="export-history" class="flex flex-col space-y-2">
                <div class="text-gray-500">No hay historial de exportaciones todav√≠a.</div>
              </div>
            </div>
          </section>
        </div>

        <!-- SECCI√ìN IMPORTAR -->
        <div id="import-section" class="flex-1 flex-col md:flex-row hidden">
          
          <!-- Lista lateral - Opciones de importaci√≥n -->
          <aside class="w-full md:w-1/3 bg-gray-50 p-6 border-b md:border-b-0 md:border-r border-gray-200">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Opciones de Importaci√≥n</h3>
            
            <!-- Importar SQLite -->
            <div class="mb-6 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
              <h4 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <span class="text-blue-600">üíæ</span>
                Base de Datos SQLite
              </h4>
              <p class="text-sm text-gray-600 mb-3">Restaura una copia de respaldo completa</p>
              <div id="sqlite-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 transition">
                <div class="text-2xl mb-2">üìÅ</div>
                <p class="text-sm text-gray-600">Arrastra tu archivo .sqlite aqu√≠</p>
                <p class="text-xs text-gray-500 mt-1">o haz clic para seleccionar</p>
              </div>
              <input type="file" id="sqlite-file-input" class="hidden" accept=".sqlite,.db">
            </div>



            <!-- Advertencias -->
            <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
              <h4 class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Importante</h4>
              <ul class="text-sm text-yellow-700 space-y-1">
                <li>‚Ä¢ Haz respaldo antes de importar</li>
                <li>‚Ä¢ Verifica que sea un archivo .sqlite o .db v√°lido</li>
                <li>‚Ä¢ La importaci√≥n reemplazar√° la base de datos actual</li>
                <li>‚Ä¢ Aseg√∫rate de que el archivo no est√© corrupto</li>
              </ul>
            </div>
          </aside>

          <!-- Panel principal - Estado y resultados -->
          <section class="w-full md:flex-1 p-6 overflow-auto relative">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-gray-800 mb-2">Importar Datos</h2>
              <p class="text-gray-600">Restaura una base de datos completa desde un archivo SQLite</p>
            </div>

            <!-- Estado de importaci√≥n -->
            <div id="import-status" class="hidden p-4 rounded-lg mb-6">
              <p id="import-message" class="font-semibold"></p>
            </div>

            <!-- Barra de progreso -->
            <div id="import-progress" class="hidden mb-6">
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="import-progress-bar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <p class="text-sm text-gray-600 mt-2">Procesando importaci√≥n...</p>
            </div>

            <!-- Resultados recientes -->
            <div class="bg-gray-50 rounded-lg p-4">
              <h3 class="font-semibold text-gray-700 mb-3">üìã Importaciones Recientes</h3>
              <div id="import-history" class="flex flex-col space-y-2">
                <div class="text-gray-500">No hay historial de importaciones todav√≠a.</div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    let currentSection = 'export';
    
    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      setupTabs();
      setupDropZones();
      setupEventListeners();
    });

    // Configurar pesta√±as
    function setupTabs() {
      const tabExport = document.getElementById('tab-export');
      const tabImport = document.getElementById('tab-import');
      const exportSection = document.getElementById('export-section');
      const importSection = document.getElementById('import-section');

      tabExport.addEventListener('click', () => {
        currentSection = 'export';
        tabExport.classList.add('text-blue-600', 'border-blue-600', 'bg-white');
        tabExport.classList.remove('text-gray-600', 'border-transparent');
        tabImport.classList.add('text-gray-600', 'border-transparent');
        tabImport.classList.remove('text-blue-600', 'border-blue-600', 'bg-white');
        exportSection.classList.remove('hidden');
        exportSection.classList.add('flex');
        importSection.classList.add('hidden');
        importSection.classList.remove('flex');
      });

      tabImport.addEventListener('click', () => {
        currentSection = 'import';
        tabImport.classList.add('text-blue-600', 'border-blue-600', 'bg-white');
        tabImport.classList.remove('text-gray-600', 'border-transparent');
        tabExport.classList.add('text-gray-600', 'border-transparent');
        tabExport.classList.remove('text-blue-600', 'border-blue-600', 'bg-white');
        importSection.classList.remove('hidden');
        importSection.classList.add('flex');
        exportSection.classList.add('hidden');
        exportSection.classList.remove('flex');
      });
    }

    // Configurar zonas de arrastrar y soltar
    function setupDropZones() {
      setupDropZone('sqlite-drop-zone', 'sqlite-file-input', handleSQLiteFile);
    }

    function setupDropZone(dropZoneId, fileInputId, handler) {
      const dropZone = document.getElementById(dropZoneId);
      const fileInput = document.getElementById(fileInputId);

      if (!dropZone || !fileInput) return;

      dropZone.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handler(e.target.files[0]);
        }
      });

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-blue-400', 'bg-blue-50');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-blue-400', 'bg-blue-50');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-400', 'bg-blue-50');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handler(files[0]);
        }
      });
    }

    // Configurar event listeners
    function setupEventListeners() {
      const exportSQLiteBtn = document.getElementById('export-sqlite');
      const exportExcelBtn = document.getElementById('export-excel');
      
      if (exportSQLiteBtn) exportSQLiteBtn.addEventListener('click', exportSQLite);
      if (exportExcelBtn) exportExcelBtn.addEventListener('click', exportExcel);
    }

    // Funci√≥n para mostrar estado
    function showStatus(type, message, statusType = 'info') {
      const statusElement = document.getElementById(type + '-status');
      const messageElement = document.getElementById(type + '-message');
      
      if (!statusElement || !messageElement) return;
      
      statusElement.classList.remove('hidden', 'bg-blue-50', 'border-blue-200', 'bg-green-50', 'border-green-200', 'bg-red-50', 'border-red-200', 'bg-yellow-50', 'border-yellow-200');
      messageElement.classList.remove('text-blue-800', 'text-green-800', 'text-red-800', 'text-yellow-800');
      
      const colors = {
        info: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-800' },
        success: { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-800' },
        error: { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-800' },
        warning: { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-800' }
      };
      
      const colorClass = colors[statusType];
      statusElement.classList.add(colorClass.bg, colorClass.border, 'border');
      messageElement.classList.add(colorClass.text);
      messageElement.textContent = message;
      
      setTimeout(() => {
        statusElement.classList.add('hidden');
      }, 5000);
    }

    // Funci√≥n para mostrar progreso
    function showProgress(type, show = true) {
      const progressElement = document.getElementById(type + '-progress');
      const progressBar = document.getElementById(type + '-progress-bar');
      
      if (!progressElement || !progressBar) return;
      
      if (show) {
        progressElement.classList.remove('hidden');
        let width = 0;
        const interval = setInterval(() => {
          width += 10;
          progressBar.style.width = width + '%';
          if (width >= 100) {
            clearInterval(interval);
            setTimeout(() => {
              progressElement.classList.add('hidden');
              progressBar.style.width = '0%';
            }, 500);
          }
        }, 150);
      } else {
        progressElement.classList.add('hidden');
        progressBar.style.width = '0%';
      }
    }

    // Funci√≥n para agregar al historial
    function addToHistory(type, message) {
      const historyElement = document.getElementById(type + '-history');
      if (!historyElement) return;
      
      const timestamp = new Date().toLocaleString();
      const historyItem = document.createElement('div');
      historyItem.className = 'text-sm text-gray-600 p-2 bg-white rounded border';
      historyItem.innerHTML = `
        <div class="flex justify-between items-start">
          <span>${message}</span>
          <span class="text-xs text-gray-400">${timestamp}</span>
        </div>
      `;
      
      // Limpiar mensaje de "no hay exportaciones"
      if (historyElement.querySelector('.text-gray-500')) {
        historyElement.innerHTML = '';
      }
      
      historyElement.insertBefore(historyItem, historyElement.firstChild);
      
      // Mantener solo los √∫ltimos 5 elementos
      while (historyElement.children.length > 5) {
        historyElement.removeChild(historyElement.lastChild);
      }
    }

    // Funciones de exportaci√≥n (simuladas - en producci√≥n usar las APIs de Node.js)
    function exportSQLite() {
      showStatus('export', '‚è≥ Exportando base de datos SQLite...', 'info');
      showProgress('export');
      
      // Simulaci√≥n - en producci√≥n usar:
      // window.initExportarView() o las funciones de exportarView.js
      setTimeout(() => {
        showStatus('export', '‚úÖ Base de datos SQLite exportada exitosamente', 'success');
        addToHistory('export', 'üíæ Base de datos SQLite exportada');
      }, 2000);
    }

    function exportExcel() {
      const selectedTables = [];
      document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
        selectedTables.push(checkbox.value);
      });
      
      if (selectedTables.length === 0) {
        showStatus('export', '‚ö†Ô∏è Selecciona al menos una tabla para exportar', 'warning');
        return;
      }
      
      showStatus('export', `‚è≥ Exportando ${selectedTables.length} tabla(s) a Excel...`, 'info');
      showProgress('export');
      
      // Simulaci√≥n - en producci√≥n usar las APIs de Node.js
      setTimeout(() => {
        showStatus('export', `‚úÖ ${selectedTables.length} tabla(s) exportada(s) a Excel exitosamente`, 'success');
        addToHistory('export', `üìä ${selectedTables.length} tabla(s) exportadas a Excel`);
      }, 2500);
    }

    // Funciones de importaci√≥n (simuladas)
    function handleSQLiteFile(file) {
      if (!file) return;
      
      if (!file.name.endsWith('.sqlite') && !file.name.endsWith('.db')) {
        showStatus('import', '‚ùå Archivo no v√°lido. Debe ser .sqlite o .db', 'error');
        return;
      }
      
      showStatus('import', '‚è≥ Importando base de datos SQLite...', 'info');
      showProgress('import');
      
      // Simulaci√≥n - en producci√≥n usar:
      // window.initImportarView() o las funciones de importarView.js
      setTimeout(() => {
        showStatus('import', '‚úÖ Base de datos SQLite importada exitosamente', 'success');
        addToHistory('import', 'üíæ Base de datos SQLite importada: ' + file.name);
      }, 2000);
    }

    // Mensaje de inicializaci√≥n
    console.log('üìä Sistema de Exportar/Importar inicializado');
    console.log('üîó Listo para conectar con exportarView.js e importarView.js');
  </script>
</body>
</html>